<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世話人・実行委員名簿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f7fafc; }
        textarea { resize: none; }
        .toast {
            visibility: hidden; opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            visibility: visible; opacity: 1; bottom: 50px;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-green-600 text-white shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold">世話人・実行委員名簿</h1>
            <p id="user-greeting" class="text-sm opacity-90">読み込み中...</p>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <div id="loading" class="text-center py-12">
            <p class="text-gray-500">データを読み込んでいます...</p>
        </div>
        <div id="member-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
    </main>
    
    <div id="toast-notification" class="toast fixed left-1/2 -translate-x-1/2 bottom-10 bg-gray-800 text-white text-center py-2 px-4 rounded-lg shadow-xl">
        更新しました
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // ▼▼▼【重要】▼▼▼
        // LINE Developersコンソールで取得した、あなた自身のLIFF IDに書き換えてください。
        // 例: const LIFF_ID = "1234567890-abcdefgh";
        const LIFF_ID = "2007976447-OJlR1NJq"; // ← ここをあなたのLIFF IDに書き換えてください！

        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                // LIFF IDが初期値のままの場合、処理を中断してエラーメッセージを表示
                if (LIFF_ID === "YOUR_LIFF_ID") {
                    throw new Error("LIFF IDが設定されていません。コードを修正してください。");
                }
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                document.getElementById('user-greeting').textContent = `ようこそ、${profile.displayName}さん`;
                fetchDataAndRender();
            } catch (error) {
                console.error('LIFF Initialization failed', error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">LIFFの初期化に失敗しました。<br>LIFF IDが正しく設定されているか確認してください。</p>`;
            }
        }

        async function fetchDataAndRender() {
            const loadingIndicator = document.getElementById('loading');
            const memberGrid = document.getElementById('member-grid');
            loadingIndicator.style.display = 'block';
            memberGrid.innerHTML = '';

            try {
                const response = await fetch('/.netlify/functions/api');
                if (!response.ok) throw new Error('Network response was not ok');
                const { members, tasks } = await response.json();
                
                loadingIndicator.style.display = 'none';
                renderMembers(members, tasks);
            } catch (error) {
                console.error('Failed to fetch data', error);
                loadingIndicator.innerHTML = '<p class="text-red-500">データの読み込みに失敗しました。</p>';
            }
        }

        function isExactBirthday(birthdateStr) {
            if (!birthdateStr) return false;
            try {
                const now = new Date();
                const jstDateString = now.toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo', month: 'numeric', day: 'numeric' });

                const dateParts = birthdateStr.split('/');
                if (dateParts.length < 2) return false;
                const normalizedBirthdate = `${parseInt(dateParts[0], 10)}/${parseInt(dateParts[1], 10)}`;
                
                return jstDateString === normalizedBirthdate;
            } catch (e) {
                console.error("Could not parse birthdate for exact day check:", birthdateStr);
                return false;
            }
        }

        function isBirthdayMonth(birthdateStr) {
            if (!birthdateStr) return false;
            try {
                const now = new Date();
                const jstMonth = now.toLocaleDateString('en-US', { timeZone: 'Asia/Tokyo', month: 'numeric' });
                
                const dateParts = birthdateStr.split('/');
                if (dateParts.length < 1) return false;
                const birthMonth = parseInt(dateParts[0], 10).toString();

                return jstMonth === birthMonth;
            } catch (e) {
                console.error("Could not parse birthdate for month check:", birthdateStr);
                return false;
            }
        }

        function renderMembers(members, tasks) {
            const memberGrid = document.getElementById('member-grid');
            memberGrid.innerHTML = '';
            const TASK1_OPTIONS = ['未定', '出席', '欠席'];
            const TASK2_OPTIONS = ['未提出', '提出済'];

            members.forEach(member => {
                const card = document.createElement('div');
                const isToday = isExactBirthday(member.birthdate);
                const isMonth = isBirthdayMonth(member.birthdate);

                let cardClass = 'bg-white rounded-lg shadow-md p-4 flex flex-col space-y-3';
                let birthdayIcon = '';

                if (isToday) {
                    cardClass += ' border-2 border-yellow-400 ring-2 ring-yellow-200';
                    birthdayIcon = '<span class="ml-2 text-xl">🎂</span>';
                } else if (isMonth) {
                    cardClass += ' border-2 border-sky-400';
                    birthdayIcon = '<span class="ml-2 text-xl">🎁</span>';
                }
                
                card.className = cardClass;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-bold flex items-center">${member.name}${birthdayIcon}</h2>
                            <p class="text-sm text-gray-500">${member.birthdate ? '誕生日: ' + member.birthdate : ''}</p>
                        </div>
                        <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">ID: ${member.id}</span>
                    </div>
                    ${createSelect(tasks.task1_name, 'task1_status', member.id, TASK1_OPTIONS, member.task1_status)}
                    ${createSelect(tasks.task2_name, 'task2_status', member.id, TASK2_OPTIONS, member.task2_status)}
                    <div class="pt-2 border-t">
                        <label class="text-sm font-medium text-gray-500">備考</label>
                        <textarea data-id="${member.id}" data-key="notes" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm h-20">${member.notes || ''}</textarea>
                    </div>
                `;
                memberGrid.appendChild(card);
            });

            memberGrid.addEventListener('change', (e) => {
                if (e.target.tagName === 'SELECT') {
                    handleUpdate(e.target);
                }
            });
            memberGrid.addEventListener('blur', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    handleUpdate(e.target);
                }
            }, true);
        }
        
        function createSelect(labelText, taskKey, memberId, options, selectedValue) {
            let optionsHtml = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            return `
                <div>
                    <label class="block text-sm font-medium text-gray-700">${labelText}</label>
                    <select data-id="${memberId}" data-key="${taskKey}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        ${optionsHtml}
                    </select>
                </div>`;
        }

        async function handleUpdate(element) {
            const memberId = element.dataset.id;
            const taskKey = element.dataset.key;
            const value = element.value;

            try {
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: memberId, key: taskKey, value: value })
                });
                if (!response.ok) throw new Error('Update failed');
                const result = await response.json();
                if (result.status === 'success') {
                    showToast('更新しました');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('更新に失敗しました', false);
            }
        }

        let toastTimer;
        function showToast(message, success = true) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${success ? 'bg-gray-800' : 'bg-red-600'}`;
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.className = 'toast';
            }, 2000);
        }
    </script>
</body>
</html>

