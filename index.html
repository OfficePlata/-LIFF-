<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–è©±äººãƒ»å®Ÿè¡Œå§”å“¡åç°¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f7fafc; }
        textarea { resize: none; }
        .toast {
            visibility: hidden; opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            visibility: visible; opacity: 1; bottom: 50px;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-green-600 text-white shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold">ä¸–è©±äººãƒ»å®Ÿè¡Œå§”å“¡åç°¿</h1>
            <p id="user-greeting" class="text-sm opacity-90">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <div id="loading" class="text-center py-12">
            <p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
        <div id="member-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
    </main>
    
    <div id="toast-notification" class="toast fixed left-1/2 -translate-x-1/2 bottom-10 bg-gray-800 text-white text-center py-2 px-4 rounded-lg shadow-xl">
        æ›´æ–°ã—ã¾ã—ãŸ
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // â–¼â–¼â–¼ã€é‡è¦ã€‘â–¼â–¼â–¼
        // LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å–å¾—ã—ãŸã€ã‚ãªãŸè‡ªèº«ã®LIFF IDã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚
        // ä¾‹: const LIFF_ID = "1234567890-abcdefgh";
        const LIFF_ID = "2007976447-OJlR1NJq"; // â† ã“ã“ã‚’ã‚ãªãŸã®LIFF IDã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼

        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                // LIFF IDãŒåˆæœŸå€¤ã®ã¾ã¾ã®å ´åˆã€å‡¦ç†ã‚’ä¸­æ–­ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (LIFF_ID === "YOUR_LIFF_ID") {
                    throw new Error("LIFF IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
                }
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                document.getElementById('user-greeting').textContent = `ã‚ˆã†ã“ãã€${profile.displayName}ã•ã‚“`;
                fetchDataAndRender();
            } catch (error) {
                console.error('LIFF Initialization failed', error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500">LIFFã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>LIFF IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
            }
        }

        async function fetchDataAndRender() {
            const loadingIndicator = document.getElementById('loading');
            const memberGrid = document.getElementById('member-grid');
            loadingIndicator.style.display = 'block';
            memberGrid.innerHTML = '';

            try {
                const response = await fetch('/.netlify/functions/api');
                if (!response.ok) throw new Error('Network response was not ok');
                const { members, tasks } = await response.json();
                
                loadingIndicator.style.display = 'none';
                renderMembers(members, tasks);
            } catch (error) {
                console.error('Failed to fetch data', error);
                loadingIndicator.innerHTML = '<p class="text-red-500">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        function isExactBirthday(birthdateStr) {
            if (!birthdateStr) return false;
            try {
                const now = new Date();
                const jstDateString = now.toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo', month: 'numeric', day: 'numeric' });

                const dateParts = birthdateStr.split('/');
                if (dateParts.length < 2) return false;
                const normalizedBirthdate = `${parseInt(dateParts[0], 10)}/${parseInt(dateParts[1], 10)}`;
                
                return jstDateString === normalizedBirthdate;
            } catch (e) {
                console.error("Could not parse birthdate for exact day check:", birthdateStr);
                return false;
            }
        }

        function isBirthdayMonth(birthdateStr) {
            if (!birthdateStr) return false;
            try {
                const now = new Date();
                const jstMonth = now.toLocaleDateString('en-US', { timeZone: 'Asia/Tokyo', month: 'numeric' });
                
                const dateParts = birthdateStr.split('/');
                if (dateParts.length < 1) return false;
                const birthMonth = parseInt(dateParts[0], 10).toString();

                return jstMonth === birthMonth;
            } catch (e) {
                console.error("Could not parse birthdate for month check:", birthdateStr);
                return false;
            }
        }

        function renderMembers(members, tasks) {
            const memberGrid = document.getElementById('member-grid');
            memberGrid.innerHTML = '';
            const TASK1_OPTIONS = ['æœªå®š', 'å‡ºå¸­', 'æ¬ å¸­'];
            const TASK2_OPTIONS = ['æœªæå‡º', 'æå‡ºæ¸ˆ'];

            members.forEach(member => {
                const card = document.createElement('div');
                const isToday = isExactBirthday(member.birthdate);
                const isMonth = isBirthdayMonth(member.birthdate);

                let cardClass = 'bg-white rounded-lg shadow-md p-4 flex flex-col space-y-3';
                let birthdayIcon = '';

                if (isToday) {
                    cardClass += ' border-2 border-yellow-400 ring-2 ring-yellow-200';
                    birthdayIcon = '<span class="ml-2 text-xl">ğŸ‚</span>';
                } else if (isMonth) {
                    cardClass += ' border-2 border-sky-400';
                    birthdayIcon = '<span class="ml-2 text-xl">ğŸ</span>';
                }
                
                card.className = cardClass;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-bold flex items-center">${member.name}${birthdayIcon}</h2>
                            <p class="text-sm text-gray-500">${member.birthdate ? 'èª•ç”Ÿæ—¥: ' + member.birthdate : ''}</p>
                        </div>
                        <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">ID: ${member.id}</span>
                    </div>
                    ${createSelect(tasks.task1_name, 'task1_status', member.id, TASK1_OPTIONS, member.task1_status)}
                    ${createSelect(tasks.task2_name, 'task2_status', member.id, TASK2_OPTIONS, member.task2_status)}
                    <div class="pt-2 border-t">
                        <label class="text-sm font-medium text-gray-500">å‚™è€ƒ</label>
                        <textarea data-id="${member.id}" data-key="notes" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm h-20">${member.notes || ''}</textarea>
                    </div>
                `;
                memberGrid.appendChild(card);
            });

            memberGrid.addEventListener('change', (e) => {
                if (e.target.tagName === 'SELECT') {
                    handleUpdate(e.target);
                }
            });
            memberGrid.addEventListener('blur', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    handleUpdate(e.target);
                }
            }, true);
        }
        
        function createSelect(labelText, taskKey, memberId, options, selectedValue) {
            let optionsHtml = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            return `
                <div>
                    <label class="block text-sm font-medium text-gray-700">${labelText}</label>
                    <select data-id="${memberId}" data-key="${taskKey}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        ${optionsHtml}
                    </select>
                </div>`;
        }

        async function handleUpdate(element) {
            const memberId = element.dataset.id;
            const taskKey = element.dataset.key;
            const value = element.value;

            try {
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: memberId, key: taskKey, value: value })
                });
                if (!response.ok) throw new Error('Update failed');
                const result = await response.json();
                if (result.status === 'success') {
                    showToast('æ›´æ–°ã—ã¾ã—ãŸ');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
            }
        }

        let toastTimer;
        function showToast(message, success = true) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${success ? 'bg-gray-800' : 'bg-red-600'}`;
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.className = 'toast';
            }, 2000);
        }
    </script>
</body>
</html>

