<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世話人・実行委員名簿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f7fafc; }
        .toast {
            visibility: hidden; opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            visibility: visible; opacity: 1; bottom: 50px;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-green-600 text-white shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold">世話人・実行委員名簿</h1>
            <p id="user-greeting" class="text-sm opacity-90">読み込み中...</p>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <div id="loading" class="text-center py-12">
            <p class="text-gray-500">データを読み込んでいます...</p>
        </div>
        <div id="member-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
    </main>
    
    <div id="toast-notification" class="toast fixed left-1/2 -translate-x-1/2 bottom-10 bg-gray-800 text-white text-center py-2 px-4 rounded-lg shadow-xl">
        更新しました
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const LIFF_ID = "";

        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                document.getElementById('user-greeting').textContent = `ようこそ、${profile.displayName}さん`;
                fetchDataAndRender();
            } catch (error) {
                console.error('LIFF Initialization failed', error);
                document.getElementById('loading').innerHTML = '<p class="text-red-500">LIFFの初期化に失敗しました。アプリを再起動してください。</p>';
            }
        }

        async function fetchDataAndRender() {
            const loadingIndicator = document.getElementById('loading');
            const memberGrid = document.getElementById('member-grid');
            loadingIndicator.style.display = 'block';
            memberGrid.innerHTML = '';

            try {
                const response = await fetch('/.netlify/functions/api');
                if (!response.ok) throw new Error('Network response was not ok');
                const { members, tasks } = await response.json();
                
                loadingIndicator.style.display = 'none';
                renderMembers(members, tasks);
            } catch (error) {
                console.error('Failed to fetch data', error);
                loadingIndicator.innerHTML = '<p class="text-red-500">データの読み込みに失敗しました。</p>';
            }
        }

        function renderMembers(members, tasks) {
            const memberGrid = document.getElementById('member-grid');
            const TASK1_OPTIONS = ['未定', '出席', '欠席'];
            const TASK2_OPTIONS = ['未提出', '提出済'];

            members.forEach(member => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-lg shadow-md p-4 flex flex-col space-y-3";
                
                const header = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-bold">${member.name}</h2>
                        </div>
                        <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">ID: ${member.id}</span>
                    </div>`;

                const task1Select = createSelect(tasks.task1_name, 'task1_status', member.id, TASK1_OPTIONS, member.task1_status);
                const task2Select = createSelect(tasks.task2_name, 'task2_status', member.id, TASK2_OPTIONS, member.task2_status);

                const notes = `
                    <div class="pt-2 border-t">
                        <h3 class="text-sm font-medium text-gray-500">備考</h3>
                        <p class="text-sm h-10">${member.notes || ' '}</p>
                    </div>`;

                card.innerHTML = header + task1Select + task2Select + notes;
                memberGrid.appendChild(card);
            });
            
            document.querySelectorAll('select[data-id]').forEach(select => {
                select.addEventListener('change', handleStatusUpdate);
            });
        }
        
        function createSelect(labelText, taskKey, memberId, options, selectedValue) {
            let optionsHtml = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            return `
                <div>
                    <label class="block text-sm font-medium text-gray-700">${labelText}</label>
                    <select data-id="${memberId}" data-key="${taskKey}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        ${optionsHtml}
                    </select>
                </div>`;
        }

        async function handleStatusUpdate(event) {
            const select = event.target;
            const memberId = select.dataset.id;
            const taskKey = select.dataset.key;
            const value = select.value;

            try {
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: memberId, key: taskKey, value: value })
                });
                if (!response.ok) throw new Error('Update failed');
                const result = await response.json();
                if (result.status === 'success') {
                    showToast('更新しました');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('更新に失敗しました', false);
            }
        }

        let toastTimer;
        function showToast(message, success = true) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${success ? 'bg-gray-800' : 'bg-red-600'}`;
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.className = 'toast';
            }, 2000);
        }
    </script>
</body>
</html>

